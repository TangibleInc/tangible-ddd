# TangibleDDD Tactician Configuration (fully wired)
#
# This file provides a ready-to-use CommandBus and QueryBus, plus the
# default naming-convention mapping used by Tangible plugins.
#
# Notes:
# - Requires `league/tactician` (suggested dependency).
# - Consumers can override services or wrap with additional middleware
#   (locking, custom transactions, metrics, etc.).

services:
  _defaults:
    autowire: true
    autoconfigure: true
    public: true

  # ============================================
  # Command Bus (write pipeline)
  # ============================================
  #
  # Middleware order:
  # 1. CommandAuditMiddleware - logs command, generates command_id
  # 2. CorrelationMiddleware - initializes correlation context
  # 3. TransactionMiddleware - starts database transaction (for ITransactionalCommand)
  # 4. DomainEventsPublishMiddleware - publishes events (writes to outbox inside transaction)
  # 5. CommandHandlerMiddleware - executes the handler
  #
  League\Tactician\CommandBus:
    public: true
    arguments:
      - '@TangibleDDD\Application\Logging\CommandAuditMiddleware'
      - '@TangibleDDD\Application\Correlation\CorrelationMiddleware'
      - '@TangibleDDD\Application\Persistence\TransactionMiddleware'
      - '@TangibleDDD\Application\Events\DomainEventsPublishMiddleware'
      - '@tactician.middleware.command_handler'

  # ============================================
  # Query Bus (read-only pipeline)
  # ============================================
  tactician.query_bus:
    class: League\Tactician\CommandBus
    public: true
    arguments:
      - '@TangibleDDD\Application\Correlation\CorrelationMiddleware'
      - '@tactician.middleware.query_handler'

  # ============================================
  # Handler Middleware
  # ============================================
  tactician.middleware.command_handler:
    class: League\Tactician\Handler\CommandHandlerMiddleware
    arguments:
      - '@service_container'
      - '@tactician.command_to_handler_mapping'

  tactician.middleware.query_handler:
    class: League\Tactician\Handler\CommandHandlerMiddleware
    arguments:
      - '@service_container'
      - '@tactician.query_to_handler_mapping'

  # ============================================
  # Naming Convention Mapping
  # ============================================
  tactician.command_to_handler_mapping:
    class: League\Tactician\Handler\Mapping\MapByNamingConvention\MapByNamingConvention
    arguments:
      - '@tactician.class_name_inflector'
      - '@tactician.method_name_inflector'

  tactician.query_to_handler_mapping:
    class: League\Tactician\Handler\Mapping\MapByNamingConvention\MapByNamingConvention
    arguments:
      - '@tactician.class_name_inflector'
      - '@tactician.method_name_inflector'

  tactician.class_name_inflector:
    class: TangibleDDD\WordPress\DI\HandlerClassNameInflector

  tactician.method_name_inflector:
    class: League\Tactician\Handler\Mapping\MapByNamingConvention\MethodName\Handle
